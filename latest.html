<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICTå‘¨æŠ¥ - æœ€æ–°æŠ¥å‘Š</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }
        .container {
            text-align: center;
            padding: 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 500px;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-bottom: 20px;
        }
        .debug-info {
            margin-top: 20px;
            font-size: 11px;
            opacity: 0.8;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            line-height: 1.3;
        }
        .manual-link {
            display: inline-block;
            margin: 10px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            text-decoration: none;
            color: white;
            transition: background 0.3s;
        }
        .manual-link:hover {
            background: rgba(255, 255, 255, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner" id="spinner"></div>
        <div class="title">ICTå‘¨æŠ¥</div>
        <div class="subtitle" id="status">æ­£åœ¨è·å–æœ€æ–°æŠ¥å‘Š...</div>
        <div id="debug-info" class="debug-info" style="display: none;"></div>
        <div id="manual-links" style="display: none;"></div>
    </div>

    <script>
        const statusEl = document.getElementById('status');
        const spinnerEl = document.getElementById('spinner');
        const debugEl = document.getElementById('debug-info');
        const linksEl = document.getElementById('manual-links');

        function debug(message) {
            console.log(message);
            debugEl.innerHTML += message + '\n';
            debugEl.style.display = 'block';
        }

        async function getLatestReportByTimestamp() {
            try {
                statusEl.textContent = 'æ­£åœ¨è·å–æ–‡ä»¶åˆ—è¡¨...';
                debug('ğŸš€ å¼€å§‹åŸºäºæ—¶é—´æˆ³è·å–æœ€æ–°æŠ¥å‘Š...');
                
                // è·å–reportsç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
                const response = await fetch('https://api.github.com/repos/wisdom-future/ict-weekly-reports/contents/reports');
                
                if (!response.ok) {
                    throw new Error(`GitHub APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }
                
                const files = await response.json();
                debug(`ğŸ“ è·å–åˆ° ${files.length} ä¸ªæ–‡ä»¶`);
                
                // ç­›é€‰HTMLæŠ¥å‘Šæ–‡ä»¶
                const reportFiles = files.filter(file => {
                    return file.name.endsWith('.html') && file.name.includes('report-');
                });
                
                debug(`ğŸ“Š ç­›é€‰å‡º ${reportFiles.length} ä¸ªæŠ¥å‘Šæ–‡ä»¶`);
                
                if (reportFiles.length === 0) {
                    throw new Error('æœªæ‰¾åˆ°æŠ¥å‘Šæ–‡ä»¶');
                }
                
                statusEl.textContent = 'æ­£åœ¨è·å–æ–‡ä»¶æ—¶é—´æˆ³...';
                
                // ä¸ºæ¯ä¸ªæ–‡ä»¶è·å–æœ€åæäº¤æ—¶é—´
                const filesWithTimestamp = [];
                
                for (const file of reportFiles) {
                    try {
                        debug(`â±ï¸ è·å– ${file.name} çš„æ—¶é—´æˆ³...`);
                        
                        // è·å–æ–‡ä»¶çš„æäº¤å†å²ï¼ˆåªå–æœ€æ–°çš„1ä¸ªæäº¤ï¼‰
                        const commitsResponse = await fetch(
                            `https://api.github.com/repos/wisdom-future/ict-weekly-reports/commits?path=reports/${file.name}&per_page=1`
                        );
                        
                        if (commitsResponse.ok) {
                            const commits = await commitsResponse.json();
                            if (commits.length > 0) {
                                const lastCommitDate = commits[0].commit.committer.date;
                                const timestamp = new Date(lastCommitDate).getTime();
                                
                                filesWithTimestamp.push({
                                    name: file.name,
                                    timestamp: timestamp,
                                    date: lastCommitDate,
                                    sha: commits[0].sha.substring(0, 7)
                                });
                                
                                debug(`   âœ… ${file.name} - ${lastCommitDate} (${commits[0].sha.substring(0, 7)})`);
                            }
                        } else {
                            debug(`   âŒ ${file.name} - æ— æ³•è·å–æäº¤ä¿¡æ¯`);
                        }
                        
                        // æ·»åŠ å°å»¶è¿Ÿé¿å…APIé™åˆ¶
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (error) {
                        debug(`   âš ï¸ ${file.name} - è·å–æ—¶é—´æˆ³å¤±è´¥: ${error.message}`);
                    }
                }
                
                if (filesWithTimestamp.length === 0) {
                    throw new Error('æ— æ³•è·å–ä»»ä½•æ–‡ä»¶çš„æ—¶é—´æˆ³');
                }
                
                statusEl.textContent = 'æ­£åœ¨æ’åºæ–‡ä»¶...';
                
                // æŒ‰æ—¶é—´æˆ³æ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
                filesWithTimestamp.sort((a, b) => b.timestamp - a.timestamp);
                
                debug('\nğŸ“‹ æŒ‰æ—¶é—´æˆ³æ’åºçš„æ–‡ä»¶åˆ—è¡¨:');
                filesWithTimestamp.forEach((file, index) => {
                    const date = new Date(file.timestamp).toLocaleString('zh-CN');
                    debug(`   ${index + 1}. ${file.name}`);
                    debug(`      æ—¶é—´: ${date}`);
                    debug(`      SHA: ${file.sha}${index === 0 ? ' â† æœ€æ–°' : ''}`);
                });
                
                const latestFile = filesWithTimestamp[0];
                const latestDate = new Date(latestFile.timestamp).toLocaleString('zh-CN');
                
                statusEl.textContent = `æ‰¾åˆ°æœ€æ–°æŠ¥å‘Š: ${latestFile.name}`;
                debug(`\nğŸ¯ é€‰æ‹©æœ€æ–°æ–‡ä»¶: ${latestFile.name}`);
                debug(`   æœ€åä¿®æ”¹: ${latestDate}`);
                
                // ç­‰å¾…2ç§’åè·³è½¬
                setTimeout(() => {
                    statusEl.textContent = 'æ­£åœ¨è·³è½¬...';
                    debug(`ğŸš€ è·³è½¬åˆ°: ./reports/${latestFile.name}`);
                    window.location.href = `./reports/${latestFile.name}`;
                }, 2000);
                
            } catch (error) {
                console.error('è·å–æœ€æ–°æŠ¥å‘Šå¤±è´¥:', error);
                debug(`âŒ é”™è¯¯: ${error.message}`);
                showError(error.message);
            }
        }

        function showError(errorMessage) {
            spinnerEl.style.display = 'none';
            statusEl.textContent = 'è·å–å¤±è´¥ï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ';
            
            debug(`\nğŸ”„ å¯åŠ¨å¤‡ç”¨æ–¹æ¡ˆ...`);
            
            // å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥å°è¯•å‡ ä¸ªå¯èƒ½çš„æœ€æ–°æ–‡ä»¶å
            const today = new Date();
            const possibleFiles = [];
            
            // ç”Ÿæˆæœ€è¿‘3å¤©çš„å¯èƒ½æ–‡ä»¶å
            for (let i = 0; i < 3; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                // å¸¸è§çš„æ—¶é—´æˆ³æ ¼å¼ï¼ˆä»æ™šåˆ°æ—©ï¼‰
                const timeStamps = ['2359', '1800', '1500', '1400', '1321', '1301', '1212', '1211', '1200', '1000'];
                timeStamps.forEach(time => {
                    possibleFiles.push(`report-${dateStr}-${time}.html`);
                });
            }
            
            debug('ğŸ” å°è¯•å¯èƒ½çš„æ–‡ä»¶å:');
            possibleFiles.forEach(file => debug(`   - ${file}`));
            
            tryPossibleFiles(possibleFiles);
        }

        async function tryPossibleFiles(fileList) {
            for (const filename of fileList) {
                try {
                    const response = await fetch(`./reports/${filename}`, { method: 'HEAD' });
                    if (response.ok) {
                        debug(`âœ… æ‰¾åˆ°æ–‡ä»¶: ${filename}`);
                        statusEl.textContent = `å¤‡ç”¨æ–¹æ¡ˆæˆåŠŸ: ${filename}`;
                        setTimeout(() => {
                            window.location.href = `./reports/${filename}`;
                        }, 1000);
                        return;
                    }
                } catch (error) {
                    continue;
                }
            }
            
            // æ‰€æœ‰å°è¯•éƒ½å¤±è´¥
            debug('âŒ å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥äº†');
            statusEl.textContent = 'æ— æ³•æ‰¾åˆ°æœ€æ–°æŠ¥å‘Š';
            spinnerEl.style.display = 'none';
            
            linksEl.style.display = 'block';
            linksEl.innerHTML = `
                <a href="https://github.com/wisdom-future/ict-weekly-reports/tree/main/reports" class="manual-link" target="_blank">
                    æŸ¥çœ‹æ‰€æœ‰æŠ¥å‘Š
                </a>
                <a href="./reports/report-2025-06-13-1321.html" class="manual-link">
                    å°è¯•æœ€æ–°æŠ¥å‘Š
                </a>
            `;
        }

        // é¡µé¢åŠ è½½åç«‹å³æ‰§è¡Œ
        getLatestReportByTimestamp();
    </script>
</body>
</html>
